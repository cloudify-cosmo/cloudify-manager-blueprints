tosca_definitions_version: cloudify_dsl_1_1

imports:
  - http://www.getcloudify.org/spec/cloudify/3.2/types.yaml
  - https://raw.githubusercontent.com/szpotona/cloudify-gcp-plugin/add_keypair/plugin.yaml
  - http://www.getcloudify.org/spec/fabric-plugin/1.2/plugin.yaml

inputs:

  use_existing_manager_keypair:
    type: boolean
    default: false

  use_existing_agent_keypair:
    type: boolean
    default: false

  use_existing_manager_group:
    type: boolean
    default: false

  use_existing_agent_group:
    type: boolean
    default: false

  manager_key_pair_file_path:
    type: string

  agent_key_pair_file_path:
    type: string

  manager_server_name:
    type: string

  manager_server_user:
    type: string
    default: ubuntu

  agents_user:
    type: string
    default: ubuntu

  image_id:
    type: string

  instance_type:
    type: string

  config:
    default: {}

  instance_properties:
    default: {}
node_templates:

  management_keypair:
    type: cloudify.gcp.nodes.KeyPair
    properties:
      use_external_resource: { get_input: use_existing_manager_keypair }
      private_key_path: { get_input: manager_key_pair_file_path }
      gcp_config: { get_property: [ gcp_configuration, gcp_config ] }
      user: { get_input: manager_server_user }

  agent_keypair:
    type: cloudify.gcp.nodes.KeyPair
    properties:
      use_external_resource: { get_input: use_existing_agent_keypair }
      private_key_path: { get_input: agent_key_pair_file_path }
      gcp_config: { get_property: [ gcp_configuration, gcp_config ] }
      user: { get_input: agents_user }

  management_security_group:
    type: cloudify.gcp.nodes.SecurityGroup
    properties:
      use_external_resource: { get_input: use_existing_manager_group }
      rules:
        - ip_protocol: tcp
          port: 22
          cidr_ip: 0.0.0.0/0
        - ip_protocol: tcp
          port: 80
          cidr_ip: 0.0.0.0/0
        - ip_protocol: tcp
          port: 443
          cidr_ip: 0.0.0.0/0          
      gcp_config: { get_property: [ gcp_configuration, gcp_config ] }
    relationships:
      - type: cloudify.gcp.relationships.contained_in
        target: cloudify_network

  manager_agent_security_group:
    type: cloudify.gcp.nodes.SecurityGroup
    properties:
      use_external_resource: { get_input: use_existing_manager_agent_group }
      source_tags:
        - agent
      target_tags:
        - manager
      rules:
        - ip_protocol: tcp
          port: 8101
        - ip_protocol: tcp
          port: 5672
        - ip_protocol: tcp
          port: 53229
      gcp_config: { get_property: [ gcp_configuration, gcp_config ] }
    relationships:
      - type: cloudify.gcp.relationships.contained_in
        target: cloudify_network

  agents_security_group:
    type: cloudify.gcp.nodes.SecurityGroup
    properties:
      use_external_resource: { get_input: use_existing_agent_group }
      target_tags:
        - agent
      rules:
        - ip_protocol: tcp
          port: 22
          cidr_ip: 0.0.0.0/0
        - ip_protocol: tcp
          port: 5985
          cidr_ip: 0.0.0.0/0
      gcp_config: { get_property: [ gcp_configuration, gcp_config ] }
    relationships:
      - type: cloudify.gcp.relationships.contained_in
        target: cloudify_network

  manager_server_ip:
    type: cloudify.gcp.nodes.ExternalIP
    properties:
      gcp_config: { get_property: [ gcp_configuration, gcp_config ] }

  manager_server:
    type: cloudify.gcp.nodes.Instance
    properties:
      image_id: { get_input: image_id }
      instance_type: { get_input: instance_type }
      install_agent: false
      gcp_config: { get_property: [ gcp_configuration, gcp_config ] }
      properties: { get_input: instance_properties }
    relationships:
      - type: cloudify.gcp.relationships.instance_connected_to_ip
        target: manager_server_ip
      - type: cloudify.gcp.relationships.instance_connected_to_keypair
        target: management_keypair
      - type: cloudify.gcp.relationships.instance_connected_to_security_group
        target: management_security_group

  manager:
    type: cloudify.nodes.CloudifyManager
    properties:
      cloudify_packages:
        agents:
          ubuntu_agent_url: http://gigaspaces-repository-eu.s3.amazonaws.com/org/cloudify3/3.2.0/m7-RELEASE/cloudify-ubuntu-agent_3.2.0-m7-b177_amd64.deb
          centos_agent_url: http://gigaspaces-repository-eu.s3.amazonaws.com/org/cloudify3/3.2.0/m8-RELEASE/cloudify-centos-final-agent_3.2.0-m8-b178_amd64.deb
          windows_agent_url: http://gigaspaces-repository-eu.s3.amazonaws.com/org/cloudify3/3.2.0/m8-RELEASE/cloudify-windows-agent_3.2.0-m8-b178_amd64.deb
        docker:
           docker_url: http://gigaspaces-repository-eu.s3.amazonaws.com/org/cloudify3/3.2.0/m7-RELEASE/cloudify-docker_3.2.0-m7-b177.tar

      cloudify:

        cloudify_agent:
          min_workers: 0
          max_workers: 5
          remote_execution_port: 22
          user: { get_input: agents_user }

        workflows:
          task_retries: -1  # this means forever
          task_retry_interval: 30

        policy_engine:
          start_timeout: 30

    relationships:
      - target: manager_server
        type: cloudify.relationships.contained_in

    interfaces:
      cloudify.interfaces.lifecycle:
        configure:  
          implementation: fabric.fabric_plugin.tasks.run_task
          inputs:
            tasks_file: scripts/configure.py
            task_name: configure_manager
            task_properties:
              gcp_config: { get_property: [ gcp_configuration, gcp_config ] }
            fabric_env:
              user: { get_input: manager_server_user }
              key_filename: { get_property: [ management_keypair, private_key_path ] }
              host_string: { get_attribute: [ manager_server_ip, gcp_resource_id ] }
        start:
          implementation: fabric.fabric_plugin.tasks.run_module_task
          inputs:
            task_mapping: cloudify_cli.bootstrap.tasks.bootstrap_docker
            task_properties:
              cloudify_packages: { get_property: [manager, cloudify_packages] }
              agent_local_key_path: { get_property: [agent_keypair, private_key_path] }
              provider_context: { get_attribute: [manager, provider_context] }
            fabric_env:
              user: { get_input: manager_server_user }
              key_filename: { get_property: [ management_keypair, private_key_path ] }
              host_string: { get_attribute: [ manager_server_ip, gcp_resource_id ] }
        stop:
          implementation: fabric.fabric_plugin.tasks.run_module_task
          inputs:
            task_mapping: cloudify_cli.bootstrap.tasks.stop_manager_container
            fabric_env:
              user: { get_input: manager_server_user }
              key_filename: { get_property: [ management_keypair, private_key_path ] }
              host_string: { get_attribute: [ manager_server_ip, gcp_resource_id ] }
        delete:
          implementation: fabric.fabric_plugin.tasks.run_module_task
          inputs:
            task_mapping: cloudify_cli.bootstrap.tasks.stop_docker_service
            fabric_env:
              user: { get_input: manager_server_user }
              key_filename: { get_property: [ management_keypair, private_key_path ] }
              host_string: { get_attribute: [ manager_server_ip, gcp_resource_id ] }

      cloudify.interfaces.validation:
        creation:
          implementation: cli.cloudify_cli.bootstrap.tasks.creation_validation
          inputs:
            cloudify_packages: { get_property: [ manager, cloudify_packages ] }

  gcp_configuration:
    type: gcp_configuration
    properties:
      gcp_config: { get_input: config }

node_types:
  gcp_configuration:
    derived_from: cloudify.nodes.Root
    properties:
      gcp_config: {}

plugins:
  cli:
    install: false
    executor: central_deployment_agent

outputs:
  manager_ip:
    value: { get_attribute: [ manager_server_ip, gcp_resource_id ] }